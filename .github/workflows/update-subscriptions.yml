name: üîÑ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫

on:
  schedule:
    - cron: '0 3 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC
  workflow_dispatch:      # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  push:
    paths:
      - 'parser.py'
      - 'requirements.txt'
      - '.github/workflows/*'

jobs:
  update-subscriptions:
    name: –°–±–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          cache: 'pip'
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
        id: parser
        run: python parser.py
        continue-on-error: true
      
      - name: üìä –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        id: stats
        run: |
          if [ -f "deploy/debug.json" ]; then
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
            sudo apt-get install -y jq
            ALIVE=$(jq '.alive' deploy/debug.json)
            TOTAL=$(jq '.total' deploy/debug.json)
            echo "alive=$ALIVE" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ: $TOTAL, —Ä–∞–±–æ—á–∏—Ö: $ALIVE"
          else
            echo "alive=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "‚ùå –§–∞–π–ª debug.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
      
      - name: üì¶ –ö–æ–º–º–∏—Ç –∏ –ø—É—à –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        if: steps.stats.outputs.alive != '0'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add deploy/
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            echo "changed=false" >> $GITHUB_ENV
          else
            git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ $(date +'%Y-%m-%d')"
            git push
            echo "changed=true" >> $GITHUB_ENV
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
          fi

      
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        if: always()
        uses: actions/upload-artifact@v4 
        with:
          name: subscriptions-${{ github.run_id }}
          path: deploy/
          retention-days: 7

