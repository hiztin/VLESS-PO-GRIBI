name: üîÑ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫

on:
  schedule:
    - cron: '0 */3 * * *'   # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  workflow_dispatch:         # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    paths:
      - 'parser.py'
      - 'requirements.txt'
      - '.github/workflows/*'

jobs:
  update-subscriptions:
    name: –°–±–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    runs-on: ubuntu-latest
    permissions:
      contents: write      # –ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip
          pip install httpx beautifulsoup4 lxml aiofiles
      
      - name: üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
        id: parser
        run: python parser.py
        continue-on-error: true
      
      - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        id: check
        run: |
          if [ -d "deploy" ] && [ "$(ls -A deploy)" ]; then
            echo "‚úÖ –ü–∞–ø–∫–∞ deploy —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "files_exist=true" >> $GITHUB_OUTPUT
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if [ -f "deploy/debug.json" ]; then
              ALIVE=$(jq -r '.alive' deploy/debug.json 2>/dev/null || echo "0")
              TOTAL=$(jq -r '.total' deploy/debug.json 2>/dev/null || echo "0")
              echo "üìä –°–µ—Ä–≤–µ—Ä–æ–≤: $TOTAL, —Ä–∞–±–æ—á–∏—Ö: $ALIVE"
            fi
            
            # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            echo "üìÑ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
            find deploy -type f -name "*.txt" | sort
          else
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ deploy –ø—É—Å—Ç–∞"
            echo "files_exist=false" >> $GITHUB_OUTPUT
          fi
      - name: üì¶ –ö–æ–º–º–∏—Ç –∏ –ø—É—à –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Å –∞–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π)
        if: steps.check.outputs.files_exist == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -f deploy/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            exit 0
          fi
          
          # –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç
          git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ $(date +'%Y-%m-%d %H:%M UTC')"
          
          # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—à–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - —Å—Ç—è–≥–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø—É—à–∏–º —Å–Ω–æ–≤–∞
          echo "üì§ –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—à–∏—Ç—å..."
          if ! git push origin main; then
            echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –ø—É—à–µ"
            git pull --rebase origin main
            echo "üì§ –ü—É—à–∏–º –ø–æ—Å–ª–µ rebase..."
            git push origin main
          fi
          
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
      
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: subscriptions-${{ github.run_id }}
          path: deploy/
          retention-days: 7
          if-no-files-found: warn

