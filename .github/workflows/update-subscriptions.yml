name: üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  update:
    name: –°–±–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}
          fetch-depth: 0
      
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip
          pip install aiohttp
      
      - name: üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
        working-directory: ./source
        run: python parser.py
        continue-on-error: false
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ deploy:"
          ls -la deploy/ || echo "–ü–∞–ø–∫–∞ deploy –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ deploy/subscriptions:"
          ls -la deploy/subscriptions/ || echo "–ü–∞–ø–∫–∞ subscriptions –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          # –ü–æ–¥—Å—á—ë—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤
          if [ -f "deploy/sub.txt" ]; then
            TOTAL=$(wc -l < deploy/sub.txt)
            echo "üìä –í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: $TOTAL"
          fi
      
      - name: üì¶ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –∫–æ–º–º–∏—Ç (–¥–∞–∂–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å—ë –∏–∑ deploy
          git add deploy/
          
          # –î–æ–±–∞–≤–ª—è–µ–º README –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
          git add README.md
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–∞–π–ª–∞—Ö, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π –∫–æ–º–º–∏—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞—Ç—ã"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º timestamp –≤ README —á–µ—Ä–µ–∑ touch
            echo "# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ $(date +'%Y-%m-%d %H:%M UTC')" > .update-timestamp
            git add .update-timestamp
            
            git commit -m "üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ $(date +'%Y-%m-%d %H:%M UTC') [skip ci]"
          else
            git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ $(date +'%Y-%m-%d %H:%M UTC')"
          fi
          
          # –ü—É—à–∏–º —Å force –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if ! git push origin main; then
            echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç, –¥–µ–ª–∞–µ–º rebase..."
            git pull --rebase origin main
            git push origin main
          fi
          
          echo "‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
