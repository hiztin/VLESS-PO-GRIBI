name:  –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤

on:
  schedule:
    - cron: '0 */3 * * *'  # –ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: write
  actions: read

jobs:
  update:
    name: –°–±–æ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}  
          fetch-depth: 0
      
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install --upgrade pip
          pip install aiohttp
      
      - name: üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
        working-directory: ./source
        run: python parser.py
        continue-on-error: false
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ deploy:"
          ls -la deploy/ || echo "–ü–∞–ø–∫–∞ deploy –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ deploy/subscriptions:"
          ls -la deploy/subscriptions/ || echo "–ü–∞–ø–∫–∞ subscriptions –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          
          # –ü–æ–¥—Å—á—ë—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤
          if [ -f "deploy/sub.txt" ]; then
            TOTAL=$(wc -l < deploy/sub.txt)
            echo "üìä –í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤: $TOTAL"
          fi
          
          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
          if [ -d "deploy/subscriptions" ]; then
            FILES=$(ls -1 deploy/subscriptions/*.txt 2>/dev/null | wc -l)
            echo "üìÅ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: $FILES"
          fi
      
      - name: üì¶ –ö–æ–º–º–∏—Ç 
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add deploy/
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            exit 0
          fi
          
          # –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç
          git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ $(date +'%Y-%m-%d %H:%M UTC')"
          
          # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—à–∏—Ç—å
          echo "üì§ –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—à–∏—Ç—å..."
          if ! git push origin main; then
            echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –ø—É—à–µ, —Å—Ç—è–≥–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git config pull.rebase true
            git pull --rebase origin main
            echo "üì§ –ü—É—à–∏–º –ø–æ—Å–ª–µ rebase..."
            git push origin main
          fi
          
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
          echo "üìÑ –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          git diff --staged --name-only
      
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: subscriptions-${{ github.run_id }}
          path: deploy/
          retention-days: 7
          if-no-files-found: warn

